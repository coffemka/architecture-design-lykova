# Отчет по лабораторной работе №5
## Реализация архитектуры на основе сервисов (микросервисной архитектуры)

## 1. Цель работы
Получение опыта организации взаимодействия сервисов с использованием контейнеров Docker и настройки непрерывной интеграции.

## 2. Реализованная архитектура

### 2.1. Состав микросервисов (3 контейнера)

| Контейнер | Назначение | Порт |
|-----------|------------|------|
| **Frontend** | Клиентская часть, интерфейс пользователя | `8080` |
| **Backend API** | Серверная логика, обработка запросов | `5000` |
| **Database** | Хранение данных | `5432` |

```

## 3. Реализация API (Backend)

### 3.1. Основные эндпоинты

#### Слоты (`/api/slots`)
- `GET /available` - получение свободных слотов
- `POST /` - создание нового слота

#### Бронирования (`/api/bookings`)
- `POST /` - создание бронирования
- `PUT /{id}/confirm` - подтверждение бронирования
- `DELETE /{id}` - отмена бронирования
- `GET /teachers/{teacherId}` - список бронирований преподавателя

#### Уведомления (`/api/notifications`)
- `POST /reminders` - отправка напоминаний
- `GET /history` - история уведомлений

### 3.2. Модели данных

```csharp
// Основные модели
- Slot (Id, TeacherId, StartTime, EndTime, Status)
- Booking (Id, SlotId, StudentId, StudentName, Topic, Status)
- Notification (Id, BookingId, Type, SentAt)
```

### 3.3. База данных
- **PostgreSQL 15** с таблицами `Slots`, `Bookings`
- Автоматическое создание таблиц при первом запуске


## 4. Контейнеризация (Docker)

### 4.1. Dockerfile для Backend

```dockerfile
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY *.csproj .
RUN dotnet restore
COPY . .
RUN dotnet publish -c Release -o /app/publish

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
EXPOSE 80
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet", "TodoApi.dll"]
```

### 4.2. Docker Compose

```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: consultationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports: ["5432:5432"]
    volumes: [postgres_data:/var/lib/postgresql/data]

  backend:
    build: ./backend
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=consultationdb;Username=postgres;Password=postgres123
    ports: ["5000:80"]
    depends_on: [postgres]

  frontend:
    image: nginx:alpine
    ports: ["8080:80"]
    volumes: [./frontend:/usr/share/nginx/html]

volumes: { postgres_data: }
```

<img width="1526" height="918" alt="image" src="https://github.com/user-attachments/assets/c858ba87-0f15-4a14-bf1a-a70e5e664e6c" />


## 5. Непрерывная интеграция (CI/CD)

### 5.1. GitHub Actions workflow

Файл: `.github/workflows/ci.yml`

```yaml
name: Test Consultation API

on:
  push: { branches: [LabWork5_V2] }
  pull_request: { branches: [LabWork5_V2] }

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: consultationdb_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres123
        ports: ["5432:5432"]

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with: { dotnet-version: '8.0.x' }
    
    - name: Build
      run: |
        dotnet restore backend/TodoApi.csproj
        dotnet build backend/TodoApi.csproj
    
    - name: Start API
      run: |
        cd backend
        dotnet run --urls=http://localhost:5000 &
        sleep 15
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Database=consultationdb_test;Username=postgres;Password=postgres123"
    
    - name: Install Newman
      run: npm install -g newman
    
    - name: Run Postman Tests
      run: |
        newman run postman/consultation-tests.json \
          --env-var "baseUrl=http://localhost:5000"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results.json
```
## 6. Интеграционные тесты (Postman)
Тесты запускаются автоматически при каждом пуше в ветку `LabWork5_V2`. Результаты доступны во вкладке **Actions** на GitHub.
<img width="1324" height="396" alt="image" src="https://github.com/user-attachments/assets/87ea07af-b23e-4791-8990-13a3dedf061d" />

<img width="501" height="685" alt="image" src="https://github.com/user-attachments/assets/71fc3cfa-3565-4514-bf8f-4e6482fce86c" />


